<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF数据提取工具 - 智能地质数据提取</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --success-color: #4cc9f0;
            --accent-color: #7209b7;
            --light-bg: #f8f9fa;
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .glass-card:hover {
            box-shadow: var(--hover-shadow);
            transform: translateY(-5px);
        }

        .feature-card {
            cursor: pointer;
            height: 100%;
            transition: var(--transition);
            overflow: hidden;
            position: relative;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .feature-card:hover::before {
            left: 100%;
        }

        .feature-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .feature-icon.text-feature {
            background: linear-gradient(135deg, var(--success-color), #4895ef);
            -webkit-background-clip: text;
        }

        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            transition: var(--transition);
            background: rgba(248, 249, 250, 0.7);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .upload-area.active {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }

        .upload-area.active::before {
            transform: scaleX(1);
        }

        .upload-icon {
            font-size: 4rem;
            color: #adb5bd;
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .upload-area.active .upload-icon {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #4895ef);
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 600;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(76, 201, 240, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 201, 240, 0.4);
        }

        .progress {
            height: 12px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .file-item:hover {
            background: rgba(67, 97, 238, 0.05);
            transform: translateX(5px);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .badge {
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }

        .feature-description {
            color: #6c757d;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .method-badge {
            font-size: 0.75rem;
            margin-left: 8px;
        }

        .extraction-options {
            background: rgba(248, 249, 250, 0.7);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .form-check-input:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .result-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            box-shadow: 0 10px 30px rgba(79, 172, 254, 0.3);
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% { transform: translate(0, 0px); }
            50% { transform: translate(0, -10px); }
            100% { transform: translate(0, 0px); }
        }

        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: var(--transition);
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.12);
        }

        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .back-btn:hover {
            background: white;
            transform: translateX(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .page-title {
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .file-count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e63946;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .loading-dots {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        .loading-dots div {
            position: absolute;
            top: 33px;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: var(--primary-color);
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        .loading-dots div:nth-child(1) {
            left: 8px;
            animation: loading-dots1 0.6s infinite;
        }
        .loading-dots div:nth-child(2) {
            left: 8px;
            animation: loading-dots2 0.6s infinite;
        }
        .loading-dots div:nth-child(3) {
            left: 32px;
            animation: loading-dots2 0.6s infinite;
        }
        .loading-dots div:nth-child(4) {
            left: 56px;
            animation: loading-dots3 0.6s infinite;
        }
        @keyframes loading-dots1 {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }
        @keyframes loading-dots3 {
            0% { transform: scale(1); }
            100% { transform: scale(0); }
        }
        @keyframes loading-dots2 {
            0% { transform: translate(0, 0); }
            100% { transform: translate(24px, 0); }
        }
    </style>
</head>
<body>
    <!-- 背景装饰元素 -->
    <div class="position-absolute w-100 h-100" style="overflow: hidden; z-index: -1;">
        <div class="position-absolute" style="top: 10%; left: 5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(67, 97, 238, 0.1) 0%, rgba(67, 97, 238, 0) 70%);"></div>
        <div class="position-absolute" style="bottom: 10%; right: 5%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(76, 201, 240, 0.1) 0%, rgba(76, 201, 240, 0) 70%);"></div>
    </div>

    <div class="container py-5">
        <!-- 功能选择页面 -->
        <div id="feature-selection" class="fade-in">
            <div class="row justify-content-center mb-5">
                <div class="col-12 text-center">
                    <h1 class="display-4 fw-bold page-title mb-3">PDF数据提取工具</h1>
                    <p class="lead text-white">智能提取地质勘探数据，让数据处理更高效</p>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <div class="glass-card feature-card p-4 h-100" onclick="selectFeature('ai')">
                        <div class="text-center">
                            <div class="feature-icon">
                                <i class="bi bi-robot"></i>
                            </div>
                            <h3 class="fw-bold mb-3">AI图像识别提取</h3>
                            <p class="feature-description mb-4">
                                使用先进的AI模型分析PDF图像内容，适合各种格式的PDF文件，
                                包括扫描版和图像型PDF，提供最高精度的数据提取。
                            </p>
                            <div class="mb-4">
                                <span class="badge bg-primary me-2">高精度</span>
                                <span class="badge bg-info me-2">通用性强</span>
                                <span class="badge bg-warning">智能识别</span>
                            </div>
                            <ul class="list-unstyled text-start">
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 支持多种数据格式提取</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 智能表格识别技术</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 处理复杂版面文档</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 支持自定义提取规则</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 mb-4">
                    <div class="glass-card feature-card p-4 h-100" onclick="selectFeature('text')">
                        <div class="text-center">
                            <div class="feature-icon text-feature">
                                <i class="bi bi-lightning-charge"></i>
                            </div>
                            <h3 class="fw-bold mb-3">文本解析提取</h3>
                            <p class="feature-description mb-4">
                                使用pdfplumber直接提取文本内容，处理速度极快，
                                专门针对可选中文本的PDF文件，精准提取钻孔数据。
                            </p>
                            <div class="mb-4">
                                <span class="badge bg-success me-2">极速处理</span>
                                <span class="badge bg-warning me-2">精准提取</span>
                                <span class="badge bg-info">批量处理</span>
                            </div>
                            <ul class="list-unstyled text-start">
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 专门提取钻孔数据</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 支持目标层号过滤</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 处理速度提升5倍</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 适合文本型PDF</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="row mt-5">

            </div>
        </div>

        <!-- AI图像识别提取界面 -->
        <div id="ai-interface" class="hidden">
            <div class="glass-card p-4 slide-in">
                <div class="d-flex align-items-center mb-4">
                    <button class="back-btn me-3" onclick="backToSelection()">
                        <i class="bi bi-arrow-left me-2"></i> 返回选择
                    </button>
                    <div>
                        <h2 class="page-title mb-1">AI图像识别提取</h2>
                        <p class="text-muted mb-0">使用先进AI技术分析PDF图像内容</p>
                    </div>
                </div>

                <!-- 提取类型选择 -->
                <div class="extraction-options">
                    <h5 class="fw-bold mb-3"><i class="bi bi-gear me-2"></i>选择提取数据类型</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="form-check card p-3 h-100" style="cursor: pointer;">
                                <input class="form-check-input" type="radio" name="extraction_type" id="drill_data" value="drill_data" checked>
                                <label class="form-check-label fw-bold" for="drill_data">
                                    钻孔数据
                                </label>
                                <small class="text-muted d-block mt-1">钻孔编号、坐标、层次、层深、层厚、层底标高</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check card p-3 h-100" style="cursor: pointer;">
                                <input class="form-check-input" type="radio" name="extraction_type" id="soil_data" value="soil_data">
                                <label class="form-check-label fw-bold" for="soil_data">
                                    静力触探数据
                                </label>
                                <small class="text-muted d-block mt-1">孔号、孔深、孔口标高、层序、层深、标高</small>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="form-check card p-3 h-100" style="cursor: pointer;">
                                <input class="form-check-input" type="radio" name="extraction_type" id="custom_data" value="custom_data">
                                <label class="form-check-label fw-bold" for="custom_data">
                                    自定义提取
                                </label>
                                <small class="text-muted d-block mt-1">根据您的需求自定义提取规则</small>
                            </div>
                        </div>
                    </div>
                    <div id="custom_prompt_container" class="hidden mt-3">
                        <label for="custom_prompt" class="form-label fw-bold">自定义提取说明</label>
                        <textarea class="form-control" id="custom_prompt" rows="3" placeholder="请详细描述您需要提取的数据类型、格式和要求..."></textarea>
                    </div>
                </div>

                <div id="upload-container-ai">
                    <div class="upload-area" id="drop-zone-ai">
                        <input type="file" id="file-input-ai" accept=".pdf" multiple class="hidden">
                        <div class="upload-icon floating">
                            <i class="bi bi-cloud-arrow-up"></i>
                        </div>
                        <h4 class="fw-bold mb-2">上传PDF文件</h4>
                        <p class="text-muted mb-3">拖放文件到此处，或点击选择文件</p>
                        <button class="btn btn-primary pulse" onclick="document.getElementById('file-input-ai').click()">
                            <i class="bi bi-folder2-open me-2"></i> 选择PDF文件
                        </button>
                        <div class="mt-3 text-muted small">
                            <i class="bi bi-info-circle me-1"></i> 支持多文件上传，单个文件最大200MB
                        </div>
                    </div>

                    <div id="file-list-container-ai" class="hidden mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0">已选择文件</h5>
                            <span class="badge bg-primary" id="file-count-ai">0 个文件</span>
                        </div>
                        <div class="file-list card">
                            <div class="card-body p-0">
                                <ul id="file-list-ai" class="list-group list-group-flush">
                                    <!-- 文件列表将在这里动态生成 -->
                                </ul>
                            </div>
                        </div>
                        <button class="btn btn-primary mt-3 w-100 py-3 fw-bold" onclick="startAIProcessing()">
                            <i class="bi bi-robot me-2"></i> 开始AI智能处理
                        </button>
                    </div>
                </div>

                <div id="progress-container-ai" class="hidden mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">AI处理进度</h5>
                        <span id="progress-percent-ai" class="fw-bold text-primary">0%</span>
                    </div>
                    <div class="progress mb-3">
                        <div id="progress-bar-ai" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span id="status-message-ai" class="text-muted">准备开始AI处理...</span>
                        <span id="processed-files-ai" class="text-muted small">0/0 文件</span>
                    </div>

                    <div class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i>处理详情</h5>
                        <div id="processing-details-ai" class="card">
                            <div class="card-body p-3">
                                <div id="file-processing-list-ai">
                                    <!-- 文件处理状态将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="result-container-ai" class="hidden mt-4">
                    <div class="result-card">
                        <div class="floating mb-3">
                            <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                        </div>
                        <h3 class="fw-bold mb-2">AI处理完成！</h3>
                        <p id="success-message-ai" class="mb-4">数据提取成功完成</p>
                        <a id="download-btn-ai" class="btn btn-light btn-lg fw-bold me-3">
                            <i class="bi bi-download me-2"></i> 下载提取结果
                        </a>
                        <button class="btn btn-outline-light btn-lg" onclick="resetAIForm()">
                            <i class="bi bi-arrow-repeat me-2"></i> 继续处理
                        </button>
                    </div>
                </div>

                <div id="error-container-ai" class="hidden mt-4">
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="alert-heading mb-1">处理遇到问题</h5>
                            <span id="error-message-ai" class="mb-0"></span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-primary me-2" onclick="resetAIForm()">重新尝试</button>
                        <button class="btn btn-outline-primary" onclick="backToSelection()">选择其他方式</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文本解析提取界面 -->
        <div id="text-interface" class="hidden">
            <div class="glass-card p-4 slide-in">
                <div class="d-flex align-items-center mb-4">
                    <button class="back-btn me-3" onclick="backToSelection()">
                        <i class="bi bi-arrow-left me-2"></i> 返回选择
                    </button>
                    <div>
                        <h2 class="page-title mb-1">文本解析提取</h2>
                        <p class="text-muted mb-0">快速提取PDF文本内容</p>
                    </div>
                </div>

                <div class="alert alert-info d-flex align-items-center">
                    <i class="bi bi-info-circle-fill me-3" style="font-size: 1.5rem;"></i>
                    <div>
                        <h6 class="alert-heading mb-1">功能说明</h6>
                        <p class="mb-0">
                            文本解析提取专门用于从可选中文本的PDF文件中快速提取钻孔数据。
                            系统会自动提取以下目标层号的数据：①1, ①2, ②1, ②2, ②3, ③, ④, ⑤1, ⑥, ⑦11, ⑦12, ⑦21, ⑦22, ⑦23, ⑨
                        </p>
                    </div>
                </div>

                <div id="upload-container-text">
                    <div class="upload-area" id="drop-zone-text">
                        <input type="file" id="file-input-text" accept=".pdf" multiple class="hidden">
                        <div class="upload-icon floating">
                            <i class="bi bi-file-earmark-text"></i>
                        </div>
                        <h4 class="fw-bold mb-2">上传PDF文件</h4>
                        <p class="text-muted mb-3">拖放文件到此处，或点击选择文件</p>
                        <button class="btn btn-success pulse" onclick="document.getElementById('file-input-text').click()">
                            <i class="bi bi-folder2-open me-2"></i> 选择PDF文件
                        </button>
                        <div class="mt-3 text-muted small">
                            <i class="bi bi-lightning me-1"></i> 文本提取模式处理速度更快
                        </div>
                    </div>

                    <div id="file-list-container-text" class="hidden mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="fw-bold mb-0">已选择文件</h5>
                            <span class="badge bg-success" id="file-count-text">0 个文件</span>
                        </div>
                        <div class="file-list card">
                            <div class="card-body p-0">
                                <ul id="file-list-text" class="list-group list-group-flush">
                                    <!-- 文件列表将在这里动态生成 -->
                                </ul>
                            </div>
                        </div>
                        <button class="btn btn-success mt-3 w-100 py-3 fw-bold" onclick="startTextProcessing()">
                            <i class="bi bi-lightning-charge me-2"></i> 开始快速文本提取
                        </button>
                    </div>
                </div>

                <div id="progress-container-text" class="hidden mt-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">文本提取进度</h5>
                        <span id="progress-percent-text" class="fw-bold text-success">0%</span>
                    </div>
                    <div class="progress mb-3">
                        <div id="progress-bar-text" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span id="status-message-text" class="text-muted">准备开始文本提取...</span>
                        <span id="processed-files-text" class="text-muted small">0/0 文件</span>
                    </div>

                    <div class="mb-4">
                        <h5 class="fw-bold mb-3"><i class="bi bi-list-check me-2"></i>处理详情</h5>
                        <div id="processing-details-text" class="card">
                            <div class="card-body p-3">
                                <div id="file-processing-list-text">
                                    <!-- 文件处理状态将在这里动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="result-container-text" class="hidden mt-4">
                    <div class="result-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <div class="floating mb-3">
                            <i class="bi bi-check-circle-fill" style="font-size: 4rem;"></i>
                        </div>
                        <h3 class="fw-bold mb-2">文本提取完成！</h3>
                        <p id="success-message-text" class="mb-4">数据提取成功完成</p>
                        <a id="download-btn-text" class="btn btn-light btn-lg fw-bold me-3">
                            <i class="bi bi-download me-2"></i> 下载提取结果
                        </a>
                        <button class="btn btn-outline-light btn-lg" onclick="resetTextForm()">
                            <i class="bi bi-arrow-repeat me-2"></i> 继续处理
                        </button>
                    </div>
                </div>

                <div id="error-container-text" class="hidden mt-4">
                    <div class="alert alert-danger d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <h5 class="alert-heading mb-1">处理遇到问题</h5>
                            <span id="error-message-text" class="mb-0"></span>
                        </div>
                    </div>
                    <div class="text-center mt-3">
                        <button class="btn btn-success me-2" onclick="resetTextForm()">重新尝试</button>
                        <button class="btn btn-outline-success" onclick="backToSelection()">选择其他方式</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let selectedFeature = '';
        let selectedAIFiles = [];
        let selectedTextFiles = [];

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化提取类型变化监听
            const extractionTypeRadios = document.querySelectorAll('input[name="extraction_type"]');
            const customPromptContainer = document.getElementById('custom_prompt_container');

            extractionTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'custom_data') {
                        customPromptContainer.classList.remove('hidden');
                    } else {
                        customPromptContainer.classList.add('hidden');
                    }
                });
            });

            // 为卡片添加点击事件
            document.querySelectorAll('.form-check.card').forEach(card => {
                card.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    radio.checked = true;
                    radio.dispatchEvent(new Event('change'));

                    // 添加选中样式
                    document.querySelectorAll('.form-check.card').forEach(c => {
                        c.style.background = 'white';
                    });
                    this.style.background = 'rgba(67, 97, 238, 0.05)';
                });
            });
        });

        // 功能选择
        function selectFeature(feature) {
            selectedFeature = feature;
            document.getElementById('feature-selection').classList.add('hidden');

            if (feature === 'ai') {
                document.getElementById('ai-interface').classList.remove('hidden');
                initializeAIFeature();
            } else {
                document.getElementById('text-interface').classList.remove('hidden');
                initializeTextFeature();
            }
        }

        function backToSelection() {
            selectedFeature = '';
            document.getElementById('feature-selection').classList.remove('hidden');
            document.getElementById('ai-interface').classList.add('hidden');
            document.getElementById('text-interface').classList.add('hidden');
        }

        // ============================ AI图像识别功能 ============================
        function initializeAIFeature() {
            const dropZoneAI = document.getElementById('drop-zone-ai');
            const fileInputAI = document.getElementById('file-input-ai');

            // 设置拖放功能
            setupDragAndDrop(dropZoneAI, fileInputAI, handleAIFiles);
        }

        function handleAIFiles(files) {
            selectedAIFiles = Array.from(files).filter(file =>
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );

            if (selectedAIFiles.length === 0) {
                showAIError('请选择PDF文件');
                return;
            }

            // 更新文件计数
            document.getElementById('file-count-ai').textContent = `${selectedAIFiles.length} 个文件`;

            // 显示文件列表
            const fileListAI = document.getElementById('file-list-ai');
            fileListAI.innerHTML = '';
            selectedAIFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-pdf text-primary me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <div class="fw-medium">${file.name}</div>
                            <div class="text-muted small">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeAIFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                fileListAI.appendChild(li);
            });

            document.getElementById('file-list-container-ai').classList.remove('hidden');
        }

        function removeAIFile(index) {
            selectedAIFiles.splice(index, 1);
            handleAIFiles(selectedAIFiles); // 重新渲染文件列表
        }

        function startAIProcessing() {
            if (selectedAIFiles.length === 0) {
                showAIError('请先选择PDF文件');
                return;
            }

            // 获取提取类型
            const extractionType = document.querySelector('input[name="extraction_type"]:checked').value;
            let customPromptValue = '';

            if (extractionType === 'custom_data') {
                customPromptValue = document.getElementById('custom_prompt').value.trim();
                if (!customPromptValue) {
                    showAIError('请输入自定义提取说明');
                    return;
                }
            }

            // 显示处理界面
            document.getElementById('file-list-container-ai').classList.add('hidden');
            document.getElementById('progress-container-ai').classList.remove('hidden');
            document.getElementById('result-container-ai').classList.add('hidden');
            document.getElementById('error-container-ai').classList.add('hidden');

            // 显示文件处理状态
            const fileProcessingListAI = document.getElementById('file-processing-list-ai');
            fileProcessingListAI.innerHTML = '';
            selectedAIFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.id = `ai-file-${index}`;
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-pdf text-primary me-3"></i>
                        <div class="fw-medium">${file.name}</div>
                    </div>
                    <div class="status"><span class="badge bg-secondary">等待处理</span></div>
                `;
                fileProcessingListAI.appendChild(div);
            });

            updateAIProgress(0, '正在准备AI处理环境...', `0/${selectedAIFiles.length} 文件`);

            // 创建FormData对象并发送请求
            const formData = new FormData();
            selectedAIFiles.forEach(file => {
                formData.append('files', file);
            });

            formData.append('extraction_type', extractionType);
            if (extractionType === 'custom_data') {
                formData.append('custom_prompt', customPromptValue);
            }

            // 发送请求到服务器
            fetch('/upload_ai', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAIProgress(100, 'AI处理完成！', `${selectedAIFiles.length}/${selectedAIFiles.length} 文件`);
                    document.getElementById('success-message-ai').textContent = data.message;
                    setTimeout(() => {
                        document.getElementById('progress-container-ai').classList.add('hidden');
                        document.getElementById('result-container-ai').classList.remove('hidden');
                        document.getElementById('download-btn-ai').href = data.download_url;
                    }, 1000);
                } else {
                    showAIError(data.error || 'AI处理失败');
                }
            })
            .catch(error => {
                showAIError('上传失败: ' + error.message);
            });

            // 模拟进度更新
            simulateAIProgress();
        }

        function simulateAIProgress() {
            let progress = 0;
            let processedFiles = 0;
            const totalFiles = selectedAIFiles.length;
            const interval = setInterval(() => {
                progress += Math.random() * 5;
                if (progress >= 95) {
                    clearInterval(interval);
                    return;
                }

                // 模拟文件处理完成
                if (progress % 20 < 5 && processedFiles < totalFiles) {
                    processedFiles++;
                    const statusElement = document.querySelector(`#ai-file-${processedFiles-1} .status`);
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="badge bg-success">已完成</span>';
                    }
                    updateAIProgress(progress, 'AI正在分析PDF文件...', `${processedFiles}/${totalFiles} 文件`);
                } else if (progress % 15 < 5) {
                    const randomIndex = Math.floor(Math.random() * totalFiles);
                    const statusElement = document.querySelector(`#ai-file-${randomIndex} .status`);
                    if (statusElement && statusElement.innerHTML.includes('等待处理')) {
                        statusElement.innerHTML = '<span class="badge bg-info">AI分析中</span>';
                    }
                }

                updateAIProgress(progress, 'AI正在分析PDF文件...', `${processedFiles}/${totalFiles} 文件`);
            }, 800);
        }

        function updateAIProgress(percent, message, filesText) {
            document.getElementById('progress-bar-ai').style.width = percent + '%';
            document.getElementById('progress-percent-ai').textContent = Math.round(percent) + '%';
            document.getElementById('status-message-ai').textContent = message;
            document.getElementById('processed-files-ai').textContent = filesText;
        }

        function showAIError(message) {
            document.getElementById('error-message-ai').textContent = message;
            document.getElementById('progress-container-ai').classList.add('hidden');
            document.getElementById('error-container-ai').classList.remove('hidden');
        }

        function resetAIForm() {
            document.getElementById('file-input-ai').value = '';
            selectedAIFiles = [];
            document.getElementById('file-list-container-ai').classList.add('hidden');
            document.getElementById('upload-container-ai').classList.remove('hidden');
            document.getElementById('progress-container-ai').classList.add('hidden');
            document.getElementById('result-container-ai').classList.add('hidden');
            document.getElementById('error-container-ai').classList.add('hidden');
            document.getElementById('custom_prompt').value = '';
        }

        // ============================ 文本提取功能 ============================
        function initializeTextFeature() {
            const dropZoneText = document.getElementById('drop-zone-text');
            const fileInputText = document.getElementById('file-input-text');

            // 设置拖放功能
            setupDragAndDrop(dropZoneText, fileInputText, handleTextFiles);
        }

        function handleTextFiles(files) {
            selectedTextFiles = Array.from(files).filter(file =>
                file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf')
            );

            if (selectedTextFiles.length === 0) {
                showTextError('请选择PDF文件');
                return;
            }

            // 更新文件计数
            document.getElementById('file-count-text').textContent = `${selectedTextFiles.length} 个文件`;

            // 显示文件列表
            const fileListText = document.getElementById('file-list-text');
            fileListText.innerHTML = '';
            selectedTextFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-pdf text-success me-3" style="font-size: 1.5rem;"></i>
                        <div>
                            <div class="fw-medium">${file.name}</div>
                            <div class="text-muted small">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeTextFile(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                fileListText.appendChild(li);
            });

            document.getElementById('file-list-container-text').classList.remove('hidden');
        }

        function removeTextFile(index) {
            selectedTextFiles.splice(index, 1);
            handleTextFiles(selectedTextFiles); // 重新渲染文件列表
        }

        function startTextProcessing() {
            if (selectedTextFiles.length === 0) {
                showTextError('请先选择PDF文件');
                return;
            }

            // 显示处理界面
            document.getElementById('file-list-container-text').classList.add('hidden');
            document.getElementById('progress-container-text').classList.remove('hidden');
            document.getElementById('result-container-text').classList.add('hidden');
            document.getElementById('error-container-text').classList.add('hidden');

            // 显示文件处理状态
            const fileProcessingListText = document.getElementById('file-processing-list-text');
            fileProcessingListText.innerHTML = '';
            selectedTextFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.id = `text-file-${index}`;
                div.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark-pdf text-success me-3"></i>
                        <div class="fw-medium">${file.name}</div>
                    </div>
                    <div class="status"><span class="badge bg-secondary">等待处理</span></div>
                `;
                fileProcessingListText.appendChild(div);
            });

            updateTextProgress(0, '正在准备文本解析环境...', `0/${selectedTextFiles.length} 文件`);

            // 创建FormData对象并发送请求
            const formData = new FormData();
            selectedTextFiles.forEach(file => {
                formData.append('files', file);
            });

            fetch('/upload_text', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateTextProgress(100, '文本提取完成！', `${selectedTextFiles.length}/${selectedTextFiles.length} 文件`);
                    document.getElementById('success-message-text').textContent = data.message;
                    setTimeout(() => {
                        document.getElementById('progress-container-text').classList.add('hidden');
                        document.getElementById('result-container-text').classList.remove('hidden');
                        document.getElementById('download-btn-text').href = data.download_url;
                    }, 1000);
                } else {
                    showTextError(data.error || '文本提取失败');
                }
            })
            .catch(error => {
                showTextError('上传失败: ' + error.message);
            });

            // 模拟进度更新
            simulateTextProgress();
        }

        function simulateTextProgress() {
            let progress = 0;
            let processedFiles = 0;
            const totalFiles = selectedTextFiles.length;
            const interval = setInterval(() => {
                progress += Math.random() * 10; // 文本提取更快
                if (progress >= 95) {
                    clearInterval(interval);
                    return;
                }

                // 模拟文件处理完成
                if (progress % 15 < 5 && processedFiles < totalFiles) {
                    processedFiles++;
                    const statusElement = document.querySelector(`#text-file-${processedFiles-1} .status`);
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="badge bg-success">已完成</span>';
                    }
                    updateTextProgress(progress, '正在解析PDF文本...', `${processedFiles}/${totalFiles} 文件`);
                } else if (progress % 10 < 5) {
                    const randomIndex = Math.floor(Math.random() * totalFiles);
                    const statusElement = document.querySelector(`#text-file-${randomIndex} .status`);
                    if (statusElement && statusElement.innerHTML.includes('等待处理')) {
                        statusElement.innerHTML = '<span class="badge bg-info">文本解析中</span>';
                    }
                }

                updateTextProgress(progress, '正在解析PDF文本...', `${processedFiles}/${totalFiles} 文件`);
            }, 500);
        }

        function updateTextProgress(percent, message, filesText) {
            document.getElementById('progress-bar-text').style.width = percent + '%';
            document.getElementById('progress-percent-text').textContent = Math.round(percent) + '%';
            document.getElementById('status-message-text').textContent = message;
            document.getElementById('processed-files-text').textContent = filesText;
        }

        function showTextError(message) {
            document.getElementById('error-message-text').textContent = message;
            document.getElementById('progress-container-text').classList.add('hidden');
            document.getElementById('error-container-text').classList.remove('hidden');
        }

        function resetTextForm() {
            document.getElementById('file-input-text').value = '';
            selectedTextFiles = [];
            document.getElementById('file-list-container-text').classList.add('hidden');
            document.getElementById('upload-container-text').classList.remove('hidden');
            document.getElementById('progress-container-text').classList.add('hidden');
            document.getElementById('result-container-text').classList.add('hidden');
            document.getElementById('error-container-text').classList.add('hidden');
        }

        // ============================ 通用功能 ============================
        function setupDragAndDrop(dropZone, fileInput, handleFilesCallback) {
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('active');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('active');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('active');

                if (e.dataTransfer.files.length) {
                    handleFilesCallback(e.dataTransfer.files);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFilesCallback(e.target.files);
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>